# 项目概览

## RFdiffusion 是什么？

RFdiffusion 是一个基于**扩散模型**的蛋白质结构设计工具。它能够：
- 从随机噪声生成全新的蛋白质结构
- 在给定模板的基础上设计蛋白质
- 设计具有特定功能的蛋白质（如结合位点）
- 生成具有对称性的蛋白质复合物

## 核心设计理念

### 1. 扩散模型框架

RFdiffusion 采用**去噪扩散概率模型 (DDPM)** 的思想：

```
噪声结构 → [去噪步骤1] → [去噪步骤2] → ... → [去噪步骤T] → 蛋白质结构
     ↑                                                              ↓
     └──────────────── 训练时添加噪声（前向过程）──────────────────┘
```

**关键点**:
- **前向过程**: 向真实蛋白质结构逐步添加噪声，直到变成纯噪声
- **反向过程**: 从噪声开始，通过神经网络预测去噪方向，逐步恢复结构
- **训练目标**: 学习在任意噪声水平下预测去噪方向

### 2. SE(3)等变性

蛋白质结构具有**旋转和平移不变性**。RFdiffusion 通过 SE(3)-等变网络确保：
- 输入结构旋转/平移后，输出也相应旋转/平移
- 模型学到的是**内在的几何关系**，而不是绝对坐标

### 3. 三轨架构

借鉴 RoseTTAFold，模型使用三个信息流：

```
┌─────────┐     ┌─────────┐     ┌──────────┐
│ MSA轨   │ ←→  │ Pair轨  │ ←→  │ 结构轨   │
│(序列信息)│     │(配对信息)│     │(3D几何) │
└─────────┘     └─────────┘     └──────────┘
     ↓               ↓                ↓
     └───────────────┴────────────────┘
              信息融合与更新
```

- **MSA轨**: 处理进化信息（如果有）或序列特征
- **Pair轨**: 处理残基对之间的关系
- **结构轨**: 处理3D坐标和方向

## 架构层次

```
┌──────────────────────────────────────────────────────┐
│                   用户接口层                          │
│  (run_inference.py, 命令行参数)                      │
└────────────────────┬─────────────────────────────────┘
                     │
┌────────────────────▼─────────────────────────────────┐
│                  推理层                               │
│  • Sampler: 基础采样器                               │
│  • ScaffoldedSampler: 支架引导采样                   │
│  • Denoise: 去噪逻辑                                 │
│  • SymGen: 对称性处理                                │
└────────────────────┬─────────────────────────────────┘
                     │
┌────────────────────▼─────────────────────────────────┐
│                  模型层                               │
│  • RoseTTAFoldModule: 主网络                         │
│  • SE3TransformerWrapper: 结构处理                   │
│  • Attention/Track 模块: 信息传递                    │
└────────────────────┬─────────────────────────────────┘
                     │
┌────────────────────▼─────────────────────────────────┐
│                  基础层                               │
│  • diffusion.py: 扩散过程                            │
│  • kinematics.py: 结构构建                           │
│  • chemical.py: 化学常量                             │
│  • util.py: 工具函数                                 │
└──────────────────────────────────────────────────────┘
```

## 工作流程概述

### 训练阶段（已完成）

1. **数据准备**: 从 PDB 数据库收集蛋白质结构
2. **前向扩散**: 对结构添加不同程度的噪声
3. **模型训练**: 学习在各个噪声水平下预测去噪方向
4. **保存模型**: 得到训练好的权重文件

### 推理阶段（用户使用）

```
1. 初始化
   ├─ 加载模型权重
   ├─ 设置推理参数
   └─ 准备输入（如支架结构）

2. 采样循环 (T步)
   ├─ 从纯噪声开始
   ├─ 每步去噪:
   │  ├─ 模型预测去噪方向
   │  ├─ 应用势能引导（可选）
   │  └─ 更新结构
   └─ 得到最终结构

3. 后处理
   ├─ 结构优化
   ├─ 序列设计
   └─ 输出 PDB 文件
```

## 关键特性

### 1. 灵活的设计模式

- **无条件生成**: 完全从噪声生成新结构
- **部分扩散 (Partial Diffusion)**: 固定部分结构，设计其余部分
- **支架引导**: 基于给定的模板结构
- **结合位点设计**: 设计能与靶标结合的蛋白

### 2. 对称性支持

支持多种对称类型：
- **循环对称 (Cn)**: n重旋转对称
- **二面体对称 (Dn)**: 循环对称 + 镜面反射
- **多面体对称**: 四面体、八面体、二十面体

### 3. 势能引导

通过可微分的势能函数引导设计：
- **紧凑性**: 控制蛋白大小（回旋半径）
- **接触数**: 控制残基间接触
- **对称性**: 维持对称性约束
- **底物结合**: 设计与配体的接触

## 与其他方法的对比

| 特性 | RFdiffusion | AlphaFold | Rosetta |
|------|-------------|-----------|---------|
| 任务 | 结构设计 | 结构预测 | 多功能设计 |
| 方法 | 扩散模型 | 深度学习 | 物理建模 |
| 速度 | 快（GPU） | 快（GPU） | 慢（CPU） |
| 多样性 | 高 | 单一预测 | 中等 |
| 可控性 | 势能引导 | 有限 | 高度可控 |

## 技术栈

- **深度学习框架**: PyTorch
- **图神经网络**: DGL (Deep Graph Library)
- **SE(3)操作**: 自定义实现
- **数值计算**: NumPy, SciPy
- **结构IO**: 自定义 PDB 解析器

## 性能考虑

### GPU 内存使用

- 典型蛋白（~100残基）: ~8GB
- 大型蛋白（~500残基）: ~24GB
- 支持梯度检查点减少内存

### 推理速度

- 单个设计（50步采样）: ~1-5分钟
- 批量设计: 可并行多个样本
- 复杂势能引导: 额外增加 20-50% 时间

## 下一步

- 阅读 [核心模块](./02_core_modules.md) 了解各个组件的详细功能
- 阅读 [推理流程](./03_inference_flow.md) 了解完整的执行过程
- 阅读 [模型架构](./04_model_architecture.md) 深入理解神经网络设计
